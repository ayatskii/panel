# Разработка панели управления и развертывания сайтов

## Оглавление

1. [Обзор системы](#обзор-системы)
2. [Архитектура проекта](#архитектура-проекта)
3. [Расположение основной логики](#расположение-основной-логики)
4. [Текущее состояние функционала](#текущее-состояние-функционала)
5. [Требования к доработке](#требования-к-доработке)
6. [План реализации](#план-реализации)

---

## Обзор системы

### Краткое описание

Панель управления для генерации и управления сайтами, которая деплоит их на Cloudflare Pages с интегрированной аналитикой трафика.

### Основные функции

- Управление множественными сайтами
- Генерация контента с помощью AI (ChatGPT, Grok)
- Деплой на Cloudflare Pages
- Аналитика трафика (встроенная система, аналогичная Umami)
- Управление шаблонами с уникализацией
- Медиа-библиотека
- Система промтов для AI

### Технологический стек

**Backend:**
- Django 4.2.7 + Django REST Framework
- PostgreSQL
- Celery (асинхронные задачи)
- Redis (кэш и брокер для Celery)

**Frontend:**
- React 18.2.0 + TypeScript
- Material-UI (MUI)
- Redux Toolkit + RTK Query
- React Router DOM

---

## Архитектура проекта

### Структура директорий

```
panel/
├── backend/              # Django REST API
│   ├── sites/           # Управление сайтами (core)
│   ├── pages/           # Управление страницами и блоками
│   ├── templates/       # Система шаблонов
│   ├── deployment/      # Деплой на Cloudflare Pages
│   ├── integrations/    # Интеграции (API токены, Cloudflare)
│   ├── analytics/       # Аналитика трафика
│   ├── media/           # Медиа-библиотека
│   ├── prompts/         # Промты для AI
│   ├── users/           # Аутентификация и пользователи
│   └── panel/           # Настройки Django
│
└── frontend/            # React + TypeScript приложение
    └── src/
        ├── pages/       # Страницы приложения (routes)
        ├── components/  # React компоненты
        ├── store/       # Redux store и API
        └── types/       # TypeScript типы
```

---

## Расположение основной логики

### Backend - Основные модули

#### 1. **Управление сайтами** (`backend/sites/`)

**Файлы:**
- `models.py` - Модели: `Site`, `Language`, `AffiliateLink`
- `views.py` - `SiteViewSet` - CRUD операции, деплой, дублирование
- `serializers.py` - Сериализаторы для API

**Ключевые функции:**
- Создание/редактирование/удаление сайтов
- Привязка к шаблонам, токенам Cloudflare, affiliate-ссылкам
- Деплой через Celery task

**Местоположение:**
```
backend/sites/
├── models.py          # Определение моделей Site, Language, AffiliateLink
├── views.py           # SiteViewSet с методами: deploy, duplicate
├── serializers.py     # Сериализация данных для API
└── services/          # Сервисы для работы с сайтами
```

#### 2. **Управление страницами и блоками** (`backend/pages/`)

**Файлы:**
- `models.py` - Модели: `Page`, `PageBlock`, `SwiperPreset`
- `views.py` - `PageViewSet` - CRUD для страниц и блоков

**Типы блоков:**
- Hero (баннер)
- Article (текстовый блок)
- Image (изображение)
- Text+Image (текст + изображение)
- CTA (призыв к действию)
- FAQ (вопросы и ответы)
- Swiper (карусель игр)

**Местоположение:**
```
backend/pages/
├── models.py          # Page, PageBlock, SwiperPreset
├── views.py           # PageViewSet
└── services/          # Сервисы для генерации контента
```

#### 3. **Система деплоя** (`backend/deployment/`)

**Файлы:**
- `tasks.py` - Celery задача `deploy_site_async` - основной процесс деплоя
- `models.py` - Модель `Deployment` для истории деплоев
- `services/template_processor.py` - Обработка шаблонов и генерация HTML/CSS
- `services/git_service.py` - Работа с Git репозиториями

**Процесс деплоя:**
1. Генерация HTML/CSS через `TemplateProcessor`
2. Создание Git репозитория
3. Загрузка файлов в Cloudflare Pages через API
4. Создание правил (Page Rules) в Cloudflare

**Местоположение:**
```
backend/deployment/
├── tasks.py                    # deploy_site_async - основная задача деплоя
├── models.py                   # Deployment модель
└── services/
    ├── template_processor.py  # Генерация HTML/CSS
    └── git_service.py         # Работа с Git
```

#### 4. **Интеграция с Cloudflare** (`backend/integrations/`)

**Файлы:**
- `cloudflare.py` - `CloudflareService` - класс для работы с Cloudflare API
- `models.py` - `ApiToken`, `CloudflareToken`
- `services/page_rules_service.py` - Управление Page Rules

**Основные методы:**
- `create_project()` - создание проекта Pages
- `create_deployment()` - создание деплоя
- `get_nameservers()` - получение NS-записей
- Управление Page Rules (редиректы, SSL)

**Местоположение:**
```
backend/integrations/
├── cloudflare.py              # CloudflareService
├── models.py                  # ApiToken, CloudflareToken
└── services/
    └── page_rules_service.py  # Управление правилами Cloudflare
```

#### 5. **Система шаблонов** (`backend/templates/`)

**Файлы:**
- `models.py` - `Template`, `TemplateFootprint`, `TemplateVariable`
- `services/uniqueness_service.py` - Уникализация CSS классов
- `services/template_processor.py` - Обработка шаблонов

**Функции уникализации:**
- Генерация уникальных CSS классов (рандомных или из списка)
- Замена классов в HTML и CSS
- Сохранение маппингов для сайта

**Местоположение:**
```
backend/templates/
├── models.py
└── services/
    ├── uniqueness_service.py    # Уникализация CSS классов
    └── template_processor.py   # Обработка шаблонов
```

#### 6. **Аналитика** (`backend/analytics/`)

**Файлы:**
- `models.py` - `Analytics`, `PageView`
- `services/realtime_analytics_service.py` - Реал-тайм аналитика
- `services/advanced_analytics_service.py` - Расширенная аналитика
- `consumers.py` - WebSocket для реал-тайм обновлений

**Функции:**
- Трекинг просмотров страниц
- Статистика по трафику (visitors, pageviews, bounce rate)
- Реал-тайм аналитика через WebSocket
- Источники трафика (organic, direct, referral, social, paid)

**Местоположение:**
```
backend/analytics/
├── models.py
├── services/
│   ├── realtime_analytics_service.py
│   └── advanced_analytics_service.py
└── consumers.py              # WebSocket consumers
```

#### 7. **Медиа-библиотека** (`backend/media/`)

**Файлы:**
- `models.py` - `Media`, `MediaFolder`, `MediaTag`
- `views.py` - Загрузка, управление, организация
- `services/favicon_generation_service.py` - Генерация favicon в разных форматах

**Местоположение:**
```
backend/media/
├── models.py
├── views.py
└── services/
    └── favicon_generation_service.py
```

#### 8. **Промты AI** (`backend/prompts/`)

**Файлы:**
- `models.py` - `Prompt` - шаблоны промтов
- `services/` - Интеграция с AI API (ChatGPT, Grok)

**Местоположение:**
```
backend/prompts/
├── models.py
└── services/                  # Интеграция с AI API
```

### Frontend - Основные модули

#### 1. **Страницы приложения** (`frontend/src/pages/`)

**Ключевые страницы:**
- `dashboard/DashboardPage.tsx` - Главная страница (список сайтов)
- `sites/SitesListPage.tsx` - Список сайтов
- `sites/SiteDetailPage.tsx` - Детали сайта (настройки, страницы, аналитика)
- `sites/SiteFormPage.tsx` - Создание/редактирование сайта
- `pages/PageBuilderPage.tsx` - Визуальный редактор страниц
- `analytics/AnalyticsDashboardPage.tsx` - Дашборд аналитики
- `media/MediaLibraryPage.tsx` - Медиа-библиотека
- `templates/TemplatesPage.tsx` - Управление шаблонами
- `prompts/PromptsPage.tsx` - Управление промтами
- `settings/SettingsPage.tsx` - Настройки системы

#### 2. **Компоненты** (`frontend/src/components/`)

**Создание сайтов:**
- `sites/SiteCreationWizard.tsx` - Мастер создания сайта (multi-step)
- `sites/DomainSetupStep.tsx` - Шаг настройки домена
- `sites/BasicConfigStep.tsx` - Базовая конфигурация
- `sites/SEOSettingsStep.tsx` - SEO настройки
- `sites/MediaAssetsStep.tsx` - Медиа-ресурсы
- `sites/PageStructureStep.tsx` - Структура страниц
- `sites/TokenSelectionModal.tsx` - Выбор токена Cloudflare

**Редактор страниц:**
- `blocks/HeroBlock.tsx` - Редактор Hero-блока
- `blocks/ArticleBlock.tsx` - Редактор Article-блока
- `blocks/FAQBlock.tsx` - Редактор FAQ-блока
- `blocks/SwiperBlock.tsx` - Редактор Swiper-блока
- `pages/ContentGenerationModal.tsx` - Модалка генерации контента AI

#### 3. **Redux Store** (`frontend/src/store/`)

**API Slices:**
- `api/sitesApi.ts` - API для работы с сайтами
- `api/pagesApi.ts` - API для работы со страницами
- `api/analyticsApi.ts` - API для аналитики
- `api/deploymentsApi.ts` - API для деплоев
- `api/templatesApi.ts` - API для шаблонов
- `api/mediaApi.ts` - API для медиа
- `api/integrationsApi.ts` - API для токенов

**Slices:**
- `slices/authSlice.ts` - Состояние аутентификации

---

## Текущее состояние функционала

### ✅ Реализовано

1. **Базовая структура:**
   - ✅ Модели данных (Site, Page, PageBlock, Template, Deployment)
   - ✅ API endpoints для всех сущностей
   - ✅ Аутентификация и авторизация (JWT, роли)

2. **Управление сайтами:**
   - ✅ Создание/редактирование/удаление сайтов
   - ✅ Мастер создания сайта (wizard)
   - ✅ Привязка шаблонов, токенов, affiliate-ссылок
   - ✅ Настройки SEO (allow_indexing, canonical, custom_head_html)

3. **Управление страницами:**
   - ✅ Создание/редактирование страниц
   - ✅ Типы блоков: Hero, Article, Image, Text+Image, CTA, FAQ, Swiper
   - ✅ Редактор блоков с drag-and-drop
   - ✅ SEO поля (title, description, h1, keywords, LSI)

4. **Деплой:**
   - ✅ Интеграция с Cloudflare Pages API
   - ✅ Генерация HTML/CSS из шаблонов
   - ✅ Деплой через Celery (асинхронно)
   - ✅ История деплоев с логами

5. **Уникализация шаблонов:**
   - ✅ Генерация уникальных CSS классов
   - ✅ Поддержка кастомных списков классов
   - ✅ Маппинг классов для сайтов

6. **Медиа-библиотека:**
   - ✅ Загрузка и управление файлами
   - ✅ Папки и теги
   - ✅ Генерация favicon в разных форматах

7. **Аналитика:**
   - ✅ Модели для трекинга
   - ✅ Реал-тайм аналитика через WebSocket
   - ✅ Базовые метрики (visitors, pageviews)

8. **Интеграции:**
   - ✅ Управление API токенами
   - ✅ Cloudflare токены с настройками

### ⚠️ Требует доработки

1. **Аналитика:**
   - ⚠️ Нужна интеграция внутрь единой панели (сейчас отдельный сервис)
   - ⚠️ Нужен полноценный дашборд как в примере

2. **Настройки системы:**
   - ⚠️ Управление списком языков (сейчас через модель Language)
   - ⚠️ Управление списками классов для уникализации

3. **Создание сайта:**
   - ⚠️ Модалка выбора токена с списком сайтов
   - ⚠️ Отображение NS-записей Cloudflare
   - ⚠️ Настройка Page Rules (редирект 404, www версия)

4. **Редактор страниц:**
   - ⚠️ Article блоки с открывающими/закрывающими тегами
   - ⚠️ Пресеты для Swiper блоков
   - ⚠️ Генерация контента AI с выбором промтов

5. **Шаблоны:**
   - ⚠️ Управление списками классов
   - ⚠️ UI для загрузки/редактирования шаблонов

6. **Dashboard:**
   - ⚠️ Доработка главной страницы (фильтры, быстрые действия)
   - ⚠️ Удаление функций SSL/IP из DNS панели
   - ⚠️ Упрощение Page Rules (только 301 редиректы)

---

## Требования к доработке

### 1. Главная страница (Dashboard)

**Текущее:** Базовая страница со списком сайтов

**Требуется:**
- ✅ Список всех готовых сайтов
- ✅ Кнопки быстрых действий: "редактировать", "дублировать", "удалить", "посмотреть аналитику"
- ✅ Фильтры по параметрам: язык, бренд, гео
- ✅ Удалить функции SSL/IP (если есть)
- ✅ Изменить функцию PAGE RULES - только для установки 301 редиректа
- ✅ Логотип с переходом на главную

### 2. Медиа-библиотека

**Текущее:** ✅ Реализована базовая функциональность

**Требуется:**
- ✅ Создание папок
- ✅ Раскидывание изображений по папкам
- ✅ Загрузка во время создания сайта/страницы

### 3. Аналитика

**Текущее:** ✅ Модели и сервисы реализованы

**Требуется:**
- ⚠️ Интеграция внутрь единой панели (как в примере)
- ⚠️ Полноценный дашборд с графиками и метриками
- ⚠️ Реал-тайм обновления

### 4. Настройки

**Требуется:**
- ⚠️ Список языков для сайтов (в формате en-EN, fr-FR) - каждый с новой строки
- ⚠️ Токены API (chat-gpt, grok, cloudflare API)
- ⚠️ Affiliate Links (переместить из Content Manager)
- ⚠️ Промты для текстов (название, тип, AI-модель, температура, сам промт)
- ⚠️ Промты для изображений

### 5. Шаблоны для сайтов

**Требуется:**
- ⚠️ Список всех загруженных шаблонов
- ⚠️ Кнопки: "редактировать", "добавить"
- ⚠️ Просмотр формата шаблонов

### 6. Добавление нового сайта

**Текущее:** ✅ Мастер создания реализован

**Требуется доработка:**

**Шаг 1 - Домен и токен:**
- ⚠️ Модалка выбора токена с таблицей:
  - Токен (человеческое имя)
  - Список сайтов на этом токене
  - Чекбокс
- ⚠️ Отображение NS-записей Cloudflare (с копированием)
- ⚠️ Кнопка "Продолжить создание"

**Шаг 2 - Настройки создания сайта:**
- ✅ Название бренда
- ✅ Language code (выбор из предустановленных)
- ✅ Affiliate link (выбор из предустановленных)
- ✅ Шаблон сайта (выбор из предустановленных)
- ✅ Чекбокс "разрешить индексирование" (по умолчанию index, follow)
- ⚠️ Чекбокс "Редирект 404 страницы на главную" (Cloudflare Rule)
- ⚠️ Чекбокс "Использовать www версию" (Cloudflare Rule)
- ✅ Выбор favicon из медиа-библиотеки
- ✅ Выбор логотипа из медиа-библиотеки
- ✅ Структура страниц (URL - название, чекбоксы для футера/хэдера/сайдбара)
- ✅ Изображения для футера
- ✅ Кнопки для Хэдера (цвет, текст, ссылка из Affiliate Link)

**При нажатии "Создать сайт":**
- ✅ Сохранение настроек и создание страниц
- ✅ Переход в раздел "страницы" сайта

### 7. Раздел "Страницы" сайта

**Текущее:** ✅ Базовый список страниц

**Требуется:**
- ⚠️ Таблица: ID, SLUG, Название
- ⚠️ Быстрые кнопки: изменить, дублировать, удалить
- ⚠️ Изменение SLUG должно обновлять в настройках сайта, хедере и футере

### 8. Редактирование страницы

**Текущее:** ✅ Реализованы поля SEO

**Требуется:**

**SEO-раздел:**
- ✅ Title (если пустой - генерация)
- ✅ Description (если пустой - генерация)
- ✅ H1 (чекбокс "Использовать в hero")
- ✅ Canonical (по умолчанию на этот домен/страницу)
- ✅ Custom Head HTML
- ✅ Ключевые фразы (каждая с новой строки)
- ✅ LSI-фразы (каждая с новой строки)

**Блоки:**
- ✅ Hero-блок (изображение, заголовок из H1, CTA text, кнопки)
- ⚠️ Article-блок (чекбоксы "Открыть article" / "Закрыть article")
- ✅ Изображение-блок
- ✅ Текст+изображение-блок
- ✅ CTA-блок
- ✅ FAQ-блок
- ✅ Swiper-блок (изображения игр, кнопки "играть", названия)
- ⚠️ Пресеты для Swiper блоков (создание, выбор готовых)

**Генерация:**
- ⚠️ Кнопка "Генерировать" с модалкой выбора блоков и промтов
- ⚠️ Возможность перегенерации отдельных блоков

**Информация:**
- ⚠️ Дата создания, дата последнего изменения
- ⚠️ Кнопка "удалить" страницу

### 9. Развертывание (Deploy)

**Текущее:** ✅ Базовая функциональность деплоя реализована

**Требуется:**
- ⚠️ При нажатии "Deploy" в настройках сайта:
  - Генерация favicon в форматах: .ico, 16x16.png, 32x32.png, 48x48.png, .svg, apple-touch-icon.png, safari-pinned-tab.svg
  - Сборка всех страниц в архив
  - Деплой на Cloudflare Pages
  - Создание Page Rules (404 редирект, www версия)
- ⚠️ При изменениях - повторный деплой

### 10. Шаблоны сайтов

**Требуется:**
- ⚠️ Просмотр формата шаблонов (HTML/CSS/JS структура)
- ⚠️ Уникализация шаблонов (уникальные классы и стили)
- ⚠️ Возможность выбора списка классов вместо рандомной генерации
- ⚠️ Управление списками классов (создание, редактирование)

---

## План реализации

### Приоритет 1: Критичные функции

1. **Настройки системы** (`backend/` + `frontend/src/pages/settings/`)
   - Управление языками (через админку или UI)
   - Управление списками классов для уникализации
   - Перемещение Affiliate Links в настройки

2. **Доработка создания сайта** (`frontend/src/components/sites/`)
   - Модалка выбора токена с таблицей сайтов
   - Отображение NS-записей
   - Настройка Page Rules (404 редирект, www)

3. **Article блоки** (`backend/pages/models.py` + `frontend/src/components/blocks/`)
   - Чекбоксы для открывающих/закрывающих тегов article
   - Логика вставки тегов в HTML

### Приоритет 2: Важные функции

4. **Пресеты Swiper** (`backend/pages/models.py` + `frontend/src/components/pages/`)
   - Модель SwiperPreset (уже есть)
   - UI для создания/выбора пресетов

5. **Генерация контента AI** (`frontend/src/components/pages/`)
   - Модалка выбора блоков и промтов
   - Интеграция с AI API
   - Перегенерация отдельных блоков

6. **Генерация favicon** (`backend/media/services/`)
   - Расширение сервиса для генерации всех форматов
   - Интеграция в процесс деплоя

### Приоритет 3: Улучшения UX

7. **Dashboard** (`frontend/src/pages/dashboard/`)
   - Фильтры и поиск
   - Быстрые действия
   - Упрощение DNS панели (если есть)

8. **Аналитика** (`frontend/src/pages/analytics/`)
   - Полноценный дашборд
   - Графики и метрики
   - Интеграция в единую панель

9. **Управление шаблонами** (`frontend/src/pages/templates/`)
   - UI для загрузки/редактирования
   - Управление списками классов
   - Просмотр формата шаблонов

---

## Выводы

### Что уже реализовано хорошо

1. ✅ Архитектура проекта продумана и масштабируема
2. ✅ Разделение на модули (sites, pages, templates, deployment)
3. ✅ Асинхронный деплой через Celery
4. ✅ Система уникализации шаблонов
5. ✅ Базовые модели и API endpoints

### Что требует доработки

1. ⚠️ UI/UX некоторые функции (модалки, формы)
2. ⚠️ Интеграция аналитики в единую панель
3. ⚠️ Расширенная генерация контента AI
4. ⚠️ Page Rules в Cloudflare
5. ⚠️ Управление настройками системы

### Рекомендации

1. Начать с приоритета 1 (критичные функции)
2. Протестировать текущий функционал на реальных данных
3. Добавить валидацию и обработку ошибок
4. Улучшить документацию API
5. Добавить unit-тесты для критичных сервисов

---

**Дата создания отчета:** 2025-01-27
**Версия проекта:** текущая разработка

